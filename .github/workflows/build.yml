name: Build VigilOS

on:
  push:
    tags: [ 'v*' ]
  workflow_dispatch:

jobs:
  build-amd64:
    runs-on: ubuntu-latest
    container: debian:bookworm-slim
    name: Build amd64 (UEFI/BIOS)

    steps:
      - name: Checkout VigilOS config
        uses: actions/checkout@v4
        with:
          repository: Vigil-OS/main
          path: config

      - name: Install live-build
        run: |
          apt-get update
          apt-get install -y live-build debian-archive-keyring qemu-user-static

      - name: Build ISO
        run: |
          lb clean
          lb build

      - name: Upload artifact
        uses: actions/upload-artifact@v2
        with:
          path: live-image-amd64.hybrid.iso
          name: vigilos-amd64.iso

  build-arm64:
    runs-on: ubuntu-latest
    container: debian:bookworm-slim
    name: Build arm64 (Raspberry Pi 4/5)

    steps:
      - name: Checkout config
        uses: actions/checkout@v4
        with:
          repository: Vigil-OS/main
          path: config

      - name: Install deps
        run: |
          apt-get update
          apt-get install -y live-build debian-archive-keyring qemu-user-static

      - name: Switch to arm64 config
        run: |
          # Если у тебя config.arm64/ в репозитории
          cp -r config config.arm64-temp
          rm -rf config
          mv config.arm64-temp config
          # Здесь можно заменить chroot.yml на arm64-версию при необходимости

      - name: Build IMG
        run: |
          lb clean
          lb build

      - name: Upload IMG
        uses: actions/upload-artifact@v2
        with:
          path: live-image-arm64.img
          name: vigilos-arm64.img
