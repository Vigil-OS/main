name: Build VigilOS

on:
  push:
    branches: [ main ]
    tags: [ 'v*' ]
  workflow_dispatch:

jobs:
  build-amd64:
    runs-on: ubuntu-latest
    container: debian:bookworm
    name: Build amd64 ISO

    # –î–æ–±–∞–≤–ª—è–µ–º –ø—Ä–∞–≤–∞ –¥–ª—è —Ä–∞–±–æ—Ç—ã —Å —É—Å—Ç—Ä–æ–π—Å—Ç–≤–∞–º–∏
    security_opt:
      - apparmor:unconfined
      - seccomp:unconfined

    steps:
      - name: üì¶ Checkout config
        uses: actions/checkout@v4
        with:
          repository: Vigil-OS/main
          path: temp-config

      - name: üîß Install live-build and deps
        run: |
          apt-get update
          apt-get install -y \
            live-build \
            debian-archive-keyring \
            sudo \
            fakeroot \
            fakechroot \
            proot \
            qemu-user-static \
            binfmt-support \
            systemd-container

      - name: üìÅ Setup config
        run: |
          cp -r temp-config/config/* .
          cat bootstrap/chroot.yml  # –ø—Ä–æ–≤–µ—Ä–∫–∞

      - name: üõ†Ô∏è Build ISO
        run: |
          lb clean
          lb build

      - name: üì¶ Upload artifact
        if: success()
        uses: actions/upload-artifact@v4
        with:
          path: live-image-amd64.hybrid.iso
          name: vigilos-amd64.iso
          retention-days: 7
