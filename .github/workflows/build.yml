name: Build VigilOS

on:
  push:
    branches: [ main ]
    tags: [ 'v*' ]
  workflow_dispatch:

jobs:
  build-amd64:
    runs-on: ubuntu-latest
    container: debian:bookworm-slim
    name: Build amd64 ISO

    steps:
      - name: ğŸ“¦ Checkout VigilOS config
        uses: actions/checkout@v4
        with:
          repository: Vigil-OS/main
          path: config

      - name: ğŸ”§ Install live-build
        run: |
          apt-get update
          apt-get install -y \
            live-build \
            debian-archive-keyring \
            sudo \
            qemu-user-static \
            binfmt-support

      - name: ğŸ› ï¸ Build ISO
        run: |
          cd config && \
          lb clean && \
          lb build

      - name: ğŸ“¦ Upload ISO
        if: success()
        uses: actions/upload-artifact@v4  # âœ… Ğ˜ÑĞ¿Ñ€Ğ°Ğ²Ğ»ĞµĞ½Ğ¾: v4 Ğ²Ğ¼ĞµÑÑ‚Ğ¾ v2
        with:
          path: live-image-amd64.hybrid.iso
          name: vigilos-amd64.iso
          retention-days: 7

  build-arm64:
    runs-on: ubuntu-latest
    container: debian:bookworm-slim
    name: Build arm64 IMG

    steps:
      - name: ğŸ“¦ Checkout VigilOS config
        uses: actions/checkout@v4
        with:
          repository: Vigil-OS/main
          path: config

      - name: ğŸ”§ Install live-build
        run: |
          apt-get update
          apt-get install -y \
            live-build \
            debian-archive-keyring \
            sudo \
            qemu-user-static \
            binfmt-support

      - name: ğŸ› ï¸ Build IMG
        run: |
          cd config && \
          lb clean && \
          lb build

      - name: ğŸ“¦ Upload IMG
        if: success()
        uses: actions/upload-artifact@v4  # âœ… Ğ˜ÑĞ¿Ñ€Ğ°Ğ²Ğ»ĞµĞ½Ğ¾: v4 Ğ²Ğ¼ĞµÑÑ‚Ğ¾ v2
        with:
          path: live-image-arm64.img
          name: vigilos-arm64.img
          retention-days: 7
