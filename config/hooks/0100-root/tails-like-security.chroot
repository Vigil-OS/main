#!/bin/sh
set -e

# üë§ –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å
adduser --disabled-password --gecos "Secure User" secure
echo "secure:toor" | chpasswd
adduser secure sudo

# üîê –ó–∞–ø—Ä–µ—Ç root
passwd -l root

# üåê Tor
systemctl enable tor

# üîí UFW: deny incoming
ufw default deny incoming
ufw default allow outgoing
ufw --force enable

# üßº –ê–º–Ω–µ–∑–∏—è
cat > /etc/rc.local << 'EOF'
#!/bin/sh
find /home/secure -type f -name "*.log" -delete
rm -rf /home/secure/.cache/* /tmp/* /var/tmp/*
echo "üßπ –ê–º–Ω–µ–∑–∏—è: –≤—Ä–µ–º–µ–Ω–Ω—ã–µ —Ñ–∞–π–ª—ã —É–¥–∞–ª–µ–Ω—ã"
exit 0
EOF
chmod +x /etc/rc.local

# üõ°Ô∏è AppArmor
systemctl enable apparmor

# üìÅ –î–æ–º–∞—à–Ω—è—è –¥–∏—Ä–µ–∫—Ç–æ—Ä–∏—è
cp -r /live/persistence/Trytonottry/VigilOS/main/* /home/secure/VigilOS/ 2>/dev/null || true
chown -R secure:secure /home/secure/VigilOS
su - secure -c "echo '/home/secure/VigilOS/startup.sh' >> ~/.bashrc"

# –û—Ç–∫–ª—é—á–∏—Ç—å Bluetooth, –ø–µ—á–∞—Ç—å, –∞–≤—Ç–æ–∑–∞–≥—Ä—É–∑–∫—É USB
systemctl mask bluetooth.service
systemctl mask cups.service
systemctl mask ModemManager.service

# –ó–∞–ø—Ä–µ—Ç–∏—Ç—å –∞–≤—Ç–æ–∑–∞–ø—É—Å–∫ USB-—É—Å—Ç—Ä–æ–π—Å—Ç–≤
echo 'SUBSYSTEM=="usb", ENV{UDISKS_IGNORE}="1"' > /etc/udev/rules.d/99-no-usb-autorun.rules

# –°–º–µ–Ω–∞ MAC-–∞–¥—Ä–µ—Å–∞
macchanger -r wlan0 2>/dev/null || true
macchanger -r eth0 2>/dev/null || true

# –ê–≤—Ç–æ–∑–∞–ø—É—Å–∫ –ø—Ä–∏ –ø–æ–¥–Ω—è—Ç–∏–∏ –∏–Ω—Ç–µ—Ä—Ñ–µ–π—Å–∞
cat > /etc/NetworkManager/dispatcher.d/01-mac-randomize << 'EOF'
#!/bin/sh
case "$2" in
    up)
        macchanger -r "$1" 2>/dev/null || true
        ;;
esac
EOF
chmod +x /etc/NetworkManager/dispatcher.d/01-mac-randomize

# –í —Ö—É–∫–µ
echo "exec startxfce4" > /home/secure/.xsession
chown secure:secure /home/secure/.xsession

# –í–∫–ª—é—á–∏—Ç—å Bluetooth
systemctl enable bluetooth

# –†–∞–∑–±–ª–æ–∫–∏—Ä–æ–≤–∞—Ç—å Wi-Fi (–µ—Å–ª–∏ –∑–∞–±–ª–æ–∫–∏—Ä–æ–≤–∞–Ω)
rfkill unblock wifi
rfkill unblock bluetooth

exit 0